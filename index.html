<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nana Piyasa Fee Manager (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for a better aesthetic and loader */
        :root {
            --primary-color: #3b82f6; /* blue-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding-bottom: 60px; /* Space for fixed nav */
        }
        .dark {
            background-color: #1f2937;
        }
        .nav-button.active {
            color: var(--primary-color);
            border-top: 3px solid var(--primary-color);
        }
        /* Loader Animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300" id="body-tag">
    <div class="app-container" id="app-root">
        <div id="main-content" class="flex-grow flex flex-col">
            <div class="p-8 text-center text-gray-500 dark:text-gray-400">Loading Application...</div>
        </div>

        <nav id="bottom-nav" class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-xl fixed bottom-0 w-full" style="max-width: 600px; margin-left: auto; margin-right: auto;"></nav>
    </div>
    
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-5 border-b dark:border-gray-700">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100"></h3>
            </div>
            <div id="modal-content" class="p-5 text-gray-700 dark:text-gray-300 text-sm"></div>
            <div class="p-4 border-t dark:border-gray-700 flex justify-end space-x-3">
                <button id="modal-cancel" class="py-2 px-4 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition hidden">Cancel</button>
                <button id="modal-ok" class="py-2 px-4 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">OK</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- GLOBAL CONSTANTS & CONFIGURATION ---
        // **IMPORTANT: Replace with your actual Gemini API Key**
        const apiKey = "YOUR_GEMINI_API_KEY_HERE"; 
        
        const GEMINI_MODEL = "gemini-2.5-flash"; 
        const FEE_AMOUNT_LKR = '1200';
        const INSTITUTE_NAME = 'Nena Piyasa Higher Education Institute';
        const DEFAULT_SENDER_PHONE = '0750882164';
        const CURRENT_YEAR = new Date().getFullYear();

        // --- INDEXEDDB CONFIG ---
        const DB_NAME = 'NenaPiyasaFeeDB';
        const DB_VERSION = 1;
        const STORE_STUDENTS = 'students';
        const STORE_CONFIG = 'config';
        let db = null; // Global IndexedDB instance

        // --- UTILITY FUNCTIONS ---
        /** Generates month names and keys (YYYY-MM) for the current year. */
        const getCurrentYearMonths = (year) => {
            const months = [];
            for (let i = 0; i < 12; i++) {
                const date = new Date(year, i, 1);
                const monthName = date.toLocaleString('en-US', { month: 'long' });
                const key = `${year}-${String(i + 1).padStart(2, '0')}`;
                months.push({ key, name: monthName, year: year });
            }
            return months;
        };
        const MONTHS_OF_YEAR = getCurrentYearMonths(CURRENT_YEAR);

        /** Creates the default reminder message. */
        const createDefaultMessage = () => {
            const month = new Date().toLocaleString('en-US', { month: 'long' });
            return `Hi [Student Name], this is a reminder that your fee of LKR ${FEE_AMOUNT_LKR} for ${month} is pending. Please clear it as soon as possible. Regards - [${INSTITUTE_NAME}]`;
        };
        
        /** Renders Lucide-like SVG Icons (simulated). */
        const Icon = (name, classes = 'w-6 h-6') => {
            const icons = {
                ArrowLeft: '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
                Plus: '<path d="M12 5v14"/><path d="M5 12h14"/>',
                Check: '<path d="M20 6 9 17l-5-5"/>',
                X: '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
                Users: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
                CreditCard: '<rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" x2="23" y1="10" y2="10"/>',
                Settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 1 1-2.2-2.19V2a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v.18a2 2 0 1 1-2.2 2.19V4a2 2 0 0 0-2 2h.18a2 2 0 1 1 2.19 2.2V10a2 2 0 0 0 2 2h.18a2 2 0 1 1 2.19 2.2V16a2 2 0 0 0 2 2h.18a2 2 0 1 1 2.2 2.19V22a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 1 1 2.2-2.19V18a2 2 0 0 0 2-2h-.18a2 2 0 1 1-2.19-2.2V12a2 2 0 0 0 2-2h.18a2 2 0 1 1-2.19-2.2V4a2 2 0 0 0-2-2h-.44zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>',
                Loader: '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>',
                Sun: '<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>',
                Moon: '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>',
                MessageSquare: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
                TrendingUp: '<polyline points="22 7 13 16 10 13 2 21"/><polyline points="16 7 22 7 22 13"/>'
            };
            // The Loader icon will spin if the animation class is added via the caller
            const isLoader = name === 'Loader';
            return `<svg class="${classes} ${isLoader ? 'animate-spin' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${icons[name] || ''}</svg>`;
        };

        // --- STATE MANAGEMENT ---
        let appState = {
            students: [],
            config: {
                messageTemplate: createDefaultMessage(),
                senderPhone: DEFAULT_SENDER_PHONE,
                darkMode: false,
            },
            totalEarnings: 0,
            isDataReady: false,
            currentPage: 'Students', 
            selectedStudent: null,
            modal: { isVisible: false, title: '', content: '', onOk: null, isPrompt: false }
        };
        
        // Get the current month key for status filtering/display
        const currentMonthKey = MONTHS_OF_YEAR.find(m => m.name === new Date().toLocaleString('en-US', { month: 'long' }))?.key;
        const currentMonthName = MONTHS_OF_YEAR.find(m => m.key === currentMonthKey)?.name;
        
        function setState(newState, shouldRender = true) {
            Object.assign(appState, newState);
            if (shouldRender) {
                renderApp();
            }
        }

        // --- INDEXEDDB IMPLEMENTATION (No external library) ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_STUDENTS)) {
                        db.createObjectStore(STORE_STUDENTS, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(STORE_CONFIG)) {
                        db.createObjectStore(STORE_CONFIG, { keyPath: 'key' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    reject(new Error("IndexedDB error: " + event.target.errorCode));
                };
            });
        }
        
        function dbOperation(storeName, mode, callback) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    return reject(new Error("Database not initialized."));
                }
                try {
                    const transaction = db.transaction(storeName, mode);
                    const store = transaction.objectStore(storeName);
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);

                    callback(store, resolve, reject);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function initDB() {
            try {
                await openDB();
                await loadAndCalculateData();
                setState({ isDataReady: true });
            } catch (error) {
                console.error("Failed to initialize database:", error);
                document.getElementById('main-content').innerHTML = `
                    <div class="p-8 text-center text-red-600 dark:text-red-400">
                        <p class="font-bold">Database Error</p>
                        <p class="text-sm">The application cannot run without local storage.</p>
                    </div>
                `;
            }
        }

        async function loadAndCalculateData() {
            const students = await getAllStudents();
            const config = await getConfig();
            
            // Calculate total earnings
            let totalEarnings = 0;
            const fee = parseFloat(FEE_AMOUNT_LKR.replace(/[^0-9.]/g, ''));
            students.forEach(student => {
                if (student.payments) {
                    const paidMonths = Object.values(student.payments).filter(paid => paid).length;
                    totalEarnings += paidMonths * fee;
                }
            });

            // Apply dark mode globally from loaded config
            const bodyEl = document.getElementById('body-tag');
            if (config.darkMode) {
                bodyEl.classList.add('dark');
                bodyEl.classList.remove('bg-gray-100');
            } else {
                bodyEl.classList.remove('dark');
                bodyEl.classList.add('bg-gray-100');
            }
            
            setState({ students, config, totalEarnings }, false); // Do not render yet
        }

        // --- CRUD OPERATIONS ---
        async function getAllStudents() {
            return new Promise((resolve, reject) => {
                dbOperation(STORE_STUDENTS, 'readonly', (store) => {
                    const request = store.getAll();
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            });
        }
        
        async function saveStudent(studentData) {
            const newStudent = {
                id: crypto.randomUUID(), // Generate a unique ID
                ...studentData,
                payments: {},
                createdAt: new Date().toISOString()
            };
            
            await dbOperation(STORE_STUDENTS, 'readwrite', (store) => {
                store.add(newStudent);
            });
            await loadAndCalculateData(); // Reload data after saving
        }

        async function updateStudentPayment(studentId, monthKey, isPaid) {
            await dbOperation(STORE_STUDENTS, 'readwrite', (store, resolve, reject) => {
                const request = store.get(studentId);
                request.onsuccess = (event) => {
                    const student = event.target.result;
                    if (student) {
                        // Toggle the payment status
                        if (isPaid) {
                            delete student.payments[monthKey]; // Set to unpaid (remove key)
                        } else {
                            student.payments[monthKey] = true; // Set to paid
                        }
                        
                        const updateRequest = store.put(student);
                        updateRequest.onsuccess = resolve;
                        updateRequest.onerror = (e) => reject(e.target.error);
                    } else {
                        reject(new Error("Student not found."));
                    }
                };
                request.onerror = (e) => reject(e.target.error);
            });
            await loadAndCalculateData(); // Reload data after update
        }

        async function getConfig() {
            const defaultConfig = {
                key: 'main',
                messageTemplate: createDefaultMessage(),
                senderPhone: DEFAULT_SENDER_PHONE,
                darkMode: false,
            };
            
            return new Promise((resolve, reject) => {
                dbOperation(STORE_CONFIG, 'readonly', (store) => {
                    const request = store.get('main');
                    request.onsuccess = (event) => {
                        const savedConfig = event.target.result;
                        resolve(savedConfig ? { ...defaultConfig, ...savedConfig } : defaultConfig);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            });
        }

        async function updateConfig(dataToUpdate) {
            await dbOperation(STORE_CONFIG, 'readwrite', (store) => {
                // Config always uses key 'main'
                store.put({ key: 'main', ...appState.config, ...dataToUpdate });
            });
            await loadAndCalculateData(); // Reload data and apply theme
        }
        
        // --- CUSTOM MODAL IMPLEMENTATION ---
        const modalEl = document.getElementById('custom-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalContentEl = document.getElementById('modal-content');
        const modalOkEl = document.getElementById('modal-ok');
        const modalCancelEl = document.getElementById('modal-cancel');

        function hideModal() {
            modalEl.classList.add('hidden');
            setState({ modal: { isVisible: false, title: '', content: '', onOk: null, isPrompt: false } }, false);
        }

        function showModal({ title, content, onOk, isPrompt = false }) {
            modalTitleEl.textContent = title;
            modalContentEl.innerHTML = content;
            modalEl.classList.remove('hidden');

            modalOkEl.onclick = () => {
                onOk && onOk(true);
                hideModal();
            };

            if (isPrompt) {
                modalCancelEl.classList.remove('hidden');
                modalCancelEl.onclick = () => {
                    onOk && onOk(false); // Cancel returns false
                    hideModal();
                };
            } else {
                modalCancelEl.classList.add('hidden');
            }
            setState({ modal: { isVisible: true, title, content, onOk, isPrompt } }, false);
        }

        // --- GEMINI API CALL FUNCTION ---
        /** Calls the Gemini API with structured JSON output and exponential backoff. */
        const geminiApiCall = async (userQuery, systemPrompt, schema) => {
            if (!apiKey || apiKey === "YOUR_GEMINI_API_KEY_HERE") {
                throw new Error("Gemini API Key is not set. Please replace 'YOUR_GEMINI_API_KEY_HERE' in the code.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            const maxRetries = 3;
            let lastError = null;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                config: {
                    systemInstruction: systemPrompt,
                    responseMimeType: "application/json",
                    responseSchema: schema,
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`HTTP error! status: ${response.status}. Details: ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (jsonText) {
                        // Gemini's JSON response is often nested within a string, so we parse it.
                        return JSON.parse(jsonText);
                    }
                    throw new Error("Gemini response was missing valid structured content.");
                } catch (error) {
                    lastError = error;
                    const delay = Math.pow(2, attempt) * 1000;
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            throw lastError;
        };

        /** Generates a tailored WhatsApp message using Gemini. */
        async function generateWhatsAppMessage(student, monthName, template) {
            const systemPrompt = `You are an AI assistant for a tuition institute. Your task is to personalize a payment reminder message template for a specific student, ensuring the message is polite and professional. Your output MUST be a JSON object matching the provided schema. DO NOT include any text outside the JSON object.`;

            const schema = {
                type: "object",
                properties: {
                    personalized_message: {
                        type: "string",
                        description: "The complete, personalized payment reminder message based on the template, with [Student Name] replaced by the actual name, and the current month confirmed."
                    }
                },
                required: ["personalized_message"]
            };

            const userQuery = `Student Name: ${student.name}. Current Month: ${monthName}. Message Template: "${template}". Generate the personalized message.`;

            const result = await geminiApiCall(userQuery, systemPrompt, schema);
            return result.personalized_message;
        }

        // --- UI COMPONENTS & RENDERING LOGIC ---
        function Avatar(name, paid) {
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const bgColor = paid ? 'bg-indigo-100 dark:bg-indigo-700' : 'bg-red-100 dark:bg-red-700';
            const textColor = paid ? 'text-indigo-600 dark:text-indigo-200' : 'text-red-600 dark:text-red-200';
            return `
                <div class="relative w-10 h-10 flex items-center justify-center rounded-full font-bold text-sm ${bgColor} ${textColor}">
                    ${initials}
                </div>
            `;
        }
        
        function StudentListItem(student) {
            // Check if the current month key exists in the payments object and is true
            const isPaid = student.payments?.[currentMonthKey] || false;
            const paymentStatusText = isPaid ? 'Paid' : 'Unpaid';
            const statusColor = isPaid ? 'text-green-500' : 'text-red-500';
            return `
                <div
                    data-student-id="${student.id}"
                    class="student-item flex items-center justify-between p-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150 cursor-pointer"
                >
                    <div class="flex items-center space-x-3">
                        ${Avatar(student.name, isPaid)}
                        <div>
                            <div class="font-semibold text-gray-900 dark:text-gray-100">${student.name}</div>
                            <div class="text-xs ${statusColor}">${paymentStatusText}</div>
                        </div>
                    </div>
                    ${Icon(isPaid ? 'Check' : 'CreditCard', 'w-5 h-5 ' + (isPaid ? 'text-green-500' : 'text-red-500'))}
                </div>
            `;
        }

        // --- VIEW: Students List ---
        function renderStudentsList() {
            const { students, totalEarnings } = appState;
            const mainContentEl = document.getElementById('main-content');
            
            // Persistent filter state for this view
            let currentFilter = mainContentEl.dataset.filter || 'All'; 

            const renderList = (filter) => {
                const filteredStudents = students.filter(student => {
                    if (filter === 'All') return true;
                    const isPaidCurrentMonth = student.payments?.[currentMonthKey] || false;
                    return filter === 'Paid' ? isPaidCurrentMonth : !isPaidCurrentMonth;
                });

                const listHtml = filteredStudents.length === 0 ? `
                    <div class="text-center p-8 text-gray-500 dark:text-gray-400">
                        No students found${filter !== 'All' ? ` who are ${filter.toLowerCase()}.` : '.'}
                    </div>
                ` : filteredStudents.map(StudentListItem).join('');

                const listContainer = document.getElementById('student-list-container');
                if (listContainer) listContainer.innerHTML = listHtml;
            };

            mainContentEl.innerHTML = `
                <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10">
                    <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">Students</h1>
                    <button id="add-student-btn" class="p-2 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition duration-150" title="Add New Student">
                        ${Icon('Plus', 'w-6 h-6')}
                    </button>
                </header>

                <div class="p-4 bg-gray-50 dark:bg-gray-900 sticky top-16 z-10 shadow-md">
                    <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-inner mb-3 flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Total YTD Earnings:</span>
                        <span class="text-xl font-bold text-green-600 dark:text-green-400">LKR ${totalEarnings.toLocaleString()}</span>
                    </div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">
                        Status for: <span class="text-blue-600 dark:text-blue-400 font-semibold">${currentMonthName} ${CURRENT_YEAR}</span>
                    </p>
                    <div id="filter-tabs" class="flex space-x-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                        ${['All', 'Unpaid', 'Paid'].map(f => `
                            <button
                                data-filter="${f}"
                                class="filter-btn flex-1 py-1.5 text-sm font-medium rounded-md transition duration-150
                                ${currentFilter === f ? 'bg-white text-blue-600 shadow-md dark:bg-gray-900' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'}">
                                ${f}
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <div id="student-list-container" class="flex-grow overflow-y-auto bg-white dark:bg-gray-800">
                    </div>
            `;

            // Attach event listeners
            document.getElementById('add-student-btn').addEventListener('click', () => setState({ currentPage: 'Add' }));

            document.getElementById('filter-tabs').addEventListener('click', (e) => {
                const btn = e.target.closest('.filter-btn');
                if (btn) {
                    currentFilter = btn.dataset.filter;
                    mainContentEl.dataset.filter = currentFilter; // Persist filter state in DOM
                    
                    // Visually update buttons
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('bg-white', 'text-blue-600', 'shadow-md', 'dark:bg-gray-900');
                        b.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
                        if (b.dataset.filter === currentFilter) {
                            b.classList.add('bg-white', 'text-blue-600', 'shadow-md', 'dark:bg-gray-900');
                            b.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
                        }
                    });
                    renderList(currentFilter);
                }
            });

            document.getElementById('student-list-container').addEventListener('click', (e) => {
                const item = e.target.closest('.student-item');
                if (item) {
                    const studentId = item.dataset.studentId;
                    const student = students.find(s => s.id === studentId);
                    if (student) {
                        setState({ selectedStudent: student, currentPage: 'Details' });
                    }
                }
            });

            renderList(currentFilter); // Initial render
        }

        // --- VIEW: Add Student ---
        function renderAddStudent() {
            const mainContentEl = document.getElementById('main-content');
            mainContentEl.innerHTML = `
                <div class="flex flex-col h-full">
                    <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center bg-white dark:bg-gray-800 shadow-sm">
                        <button id="back-to-students-btn" class="mr-4 text-gray-600 dark:text-gray-300">
                            ${Icon('ArrowLeft', 'w-6 h-6')}
                        </button>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">Add Student</h1>
                    </header>
                    
                    <form id="add-student-form" class="flex flex-col flex-grow p-5 bg-gray-50 dark:bg-gray-900">
                        <div class="space-y-6 flex-grow">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Student Name</label>
                                <input
                                    id="student-name"
                                    type="text"
                                    class="w-full text-lg border-0 p-0 focus:ring-0 bg-transparent text-gray-900 dark:text-gray-100"
                                    placeholder="Enter student name"
                                    required
                                />
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Phone Number</label>
                                <input
                                    id="student-phone"
                                    type="tel"
                                    class="w-full text-lg border-0 p-0 focus:ring-0 bg-transparent text-gray-900 dark:text-gray-100"
                                    placeholder="Enter phone number (e.g., 07x-xxxxxxx or +947x-xxxxxxx)"
                                    required
                                />
                            </div>
                            
                            <p id="add-error" class="text-sm text-red-500 text-center hidden"></p>
                        </div>
                        
                        <button
                            id="save-student-btn"
                            type="submit"
                            class="mt-6 w-full py-3 bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center"
                        >
                            Save
                        </button>
                    </form>
                </div>
            `;

            // Attach event listeners
            document.getElementById('back-to-students-btn').addEventListener('click', () => setState({ currentPage: 'Students' }));

            document.getElementById('add-student-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('student-name');
                const phoneInput = document.getElementById('student-phone');
                const errorEl = document.getElementById('add-error');
                const saveBtn = document.getElementById('save-student-btn');

                errorEl.classList.add('hidden');

                const name = nameInput.value.trim();
                const phone = phoneInput.value.trim();
                // Basic clean: remove all non-digit, non-plus characters
                const cleanPhone = phone.replace(/[^0-9+]/g, ''); 

                if (!name || !cleanPhone || cleanPhone.length < 5) {
                    errorEl.textContent = 'Please enter a valid Name and Phone Number.';
                    errorEl.classList.remove('hidden');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = `${Icon('Loader', 'w-5 h-5 mr-2')} Saving...`;

                try {
                    await saveStudent({ name, phone: cleanPhone });
                    // loadAndCalculateData will be called inside saveStudent, which updates state.
                    setState({ currentPage: 'Students' }); 
                } catch (err) {
                    errorEl.textContent = 'Failed to add student. Please try again.';
                    errorEl.classList.remove('hidden');
                    console.error(err);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = `Save`;
                }
            });
        }

        // --- VIEW: Student Details ---
        function renderStudentDetails() {
            const { selectedStudent, config, students } = appState;
            if (!selectedStudent) {
                return setState({ currentPage: 'Students' });
            }

            // Get the latest student data from the main array
            const student = students.find(s => s.id === selectedStudent.id) || selectedStudent;
            
            // Re-select the student in state with the latest data, in case they navigated back
            if(student.id !== selectedStudent.id || student.payments !== selectedStudent.payments) {
                setState({ selectedStudent: student }, false);
            }

            const isCurrentMonthPaid = student.payments?.[currentMonthKey] || false;
            const reminderButtonText = isCurrentMonthPaid ? 'Payment Confirmed' : 'Send Payment Reminder (AI)';

            const mainContentEl = document.getElementById('main-content');
            
            mainContentEl.innerHTML = `
                <div class="flex flex-col h-full">
                    <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center bg-white dark:bg-gray-800 shadow-sm">
                        <button id="back-to-students-btn" class="mr-4 text-gray-600 dark:text-gray-300">
                            ${Icon('ArrowLeft', 'w-6 h-6')}
                        </button>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">Student Details</h1>
                    </header>
                    
                    <div class="flex-grow overflow-y-auto p-5 bg-gray-50 dark:bg-gray-900">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg text-center mb-6">
                            <div class="mx-auto w-24 h-24 mb-3 rounded-full overflow-hidden bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                <span class="text-4xl font-light text-gray-600 dark:text-gray-300">
                                    ${student.name.split(' ').map(n => n[0]).join('').slice(0, 2)}
                                </span>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${student.name}</h2>
                            <p class="text-gray-500 dark:text-gray-400 font-mono text-sm">${student.phone}</p>
                            
                            <button
                                id="send-whatsapp-btn"
                                data-student-id="${student.id}"
                                ${isCurrentMonthPaid ? 'disabled' : ''}
                                class="mt-4 w-full py-2 px-4 text-sm font-semibold rounded-lg transition duration-150 flex items-center justify-center
                                ${isCurrentMonthPaid ? 'bg-gray-200 text-gray-500 cursor-not-allowed dark:bg-gray-700 dark:text-gray-400' : 'bg-green-500 text-white hover:bg-green-600 shadow-md'}"
                            >
                                ${Icon('MessageSquare', 'w-5 h-5 mr-2')}
                                <span id="whatsapp-btn-text">${reminderButtonText}</span>
                            </button>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-5">
                            <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Payments (${CURRENT_YEAR})</h3>
                            <div id="payment-ledger" class="space-y-3">
                                ${MONTHS_OF_YEAR.map(month => {
                                    // Check if month key is explicitly set to true
                                    const isPaid = student.payments?.[month.key] || false; 
                                    const statusText = isPaid ? 'Paid' : 'Unpaid';
                                    
                                    // Determine button background for paid/unpaid states
                                    const btnBgClass = isPaid 
                                        ? 'bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:hover:bg-green-800' 
                                        : 'bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800';
                                        
                                    // Determine icon color
                                    const iconColorClass = isPaid 
                                        ? 'text-green-600 dark:text-green-400' 
                                        : 'text-red-600 dark:text-red-400';

                                    return `
                                        <div class="flex items-center justify-between p-3 rounded-lg border dark:border-gray-700 transition duration-100 hover:shadow-sm">
                                            <div class="text-gray-900 dark:text-gray-100">
                                                ${month.name}
                                                <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">LKR ${FEE_AMOUNT_LKR}</span>
                                            </div>
                                            <div class="flex items-center space-x-3">
                                                <span class="text-sm font-medium ${isPaid ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} min-w-[55px] text-right">
                                                    ${statusText}
                                                </span>
                                                <button
                                                    data-month-key="${month.key}"
                                                    data-is-paid="${isPaid}"
                                                    class="toggle-payment-btn p-1 rounded-full ${btnBgClass} transition"
                                                    title="${isPaid ? 'Mark as Unpaid' : 'Mark as Paid'}"
                                                >
                                                    ${Icon(isPaid ? 'Check' : 'CreditCard', 'w-5 h-5 ' + iconColorClass)}
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // --- Event Listeners for Details View ---
            document.getElementById('back-to-students-btn').addEventListener('click', () => setState({ currentPage: 'Students' }));

            document.getElementById('payment-ledger').addEventListener('click', async (e) => {
                const btn = e.target.closest('.toggle-payment-btn');
                if (btn) {
                    const studentId = student.id; 
                    const monthKey = btn.dataset.monthKey;
                    const isPaid = btn.dataset.isPaid === 'true';

                    btn.disabled = true;
                    const oldContent = btn.innerHTML;
                    // Note: This relies on the original button's HTML to correctly re-apply colors on error.
                    
                    // Change to loading spinner state
                    btn.innerHTML = Icon('Loader', 'w-5 h-5 text-gray-600 dark:text-gray-300'); 
                    btn.classList.remove('bg-green-100', 'bg-red-100', 'dark:bg-green-900', 'dark:bg-red-900', 'hover:bg-green-200', 'hover:bg-red-200', 'dark:hover:bg-green-800', 'dark:hover:bg-red-800');
                    btn.classList.add('bg-gray-300', 'dark:bg-gray-600');

                    try {
                        await updateStudentPayment(studentId, monthKey, isPaid);
                        // loadAndCalculateData is called in updateStudentPayment, which updates state and re-renders
                    } catch (error) {
                        showModal({ title: 'Payment Error', content: 'Could not update payment status. Please try again.', onOk: () => {} });
                        console.error("Failed to toggle payment status:", error);
                        
                        // Revert button state on error
                        btn.innerHTML = oldContent;
                        btn.disabled = false;
                        btn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                        
                        // Restore original color class
                        const restoredColorClass = isPaid 
                            ? 'bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:hover:bg-green-800' 
                            : 'bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800';
                        btn.classList.add(...restoredColorClass.split(' '));
                    }
                }
            });

            document.getElementById('send-whatsapp-btn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const btnTextEl = document.getElementById('whatsapp-btn-text');
                const originalText = btnTextEl.textContent;

                if (isCurrentMonthPaid) return; 

                btn.disabled = true;
                btnTextEl.innerHTML = `${Icon('Loader', 'w-5 h-5 mr-2 text-white')} Generating Message...`;
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-blue-600'); 
                
                try {
                    const personalizedMessage = await generateWhatsAppMessage(
                        student, 
                        currentMonthName, 
                        config.messageTemplate
                    );

                    const encodedMessage = encodeURIComponent(personalizedMessage);
                    // Standard WhatsApp link format: removes '+' from phone number for wa.me compatibility
                    const whatsappLink = `https://wa.me/${student.phone.replace('+', '')}?text=${encodedMessage}`; 
                    
                    window.open(whatsappLink, '_blank');
                    
                    // Revert button state after success (open)
                    btnTextEl.textContent = originalText;
                    btn.disabled = false;
                    btn.classList.add('bg-green-500', 'hover:bg-green-600');
                    btn.classList.remove('bg-blue-600'); 

                } catch (error) {
                    showModal({ 
                        title: 'AI Message Error', 
                        content: `<p>Failed to generate the WhatsApp message. Check if the **Gemini API Key** is set correctly in the code.</p><p class="mt-2 text-xs">Error: ${error.message}</p>`, 
                        onOk: () => {} 
                    });

                    // Revert button state on error
                    btnTextEl.textContent = originalText;
                    btn.disabled = false;
                    btn.classList.add('bg-green-500', 'hover:bg-green-600');
                    btn.classList.remove('bg-blue-600'); 
                    console.error("Gemini Message Generation Failed:", error);
                }
            });
        }

        // --- VIEW: Settings ---
        function renderSettings() {
            const { config } = appState;
            const mainContentEl = document.getElementById('main-content');
            
            mainContentEl.innerHTML = `
                <div class="flex flex-col h-full">
                    <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10">
                        <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">${Icon('Settings', 'w-6 h-6 mr-2 inline-block')} Settings</h1>
                    </header>
                    
                    <div class="flex-grow overflow-y-auto p-5 bg-gray-50 dark:bg-gray-900 space-y-6">
                        
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Appearance</h3>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700 dark:text-gray-300">Dark Mode</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dark-mode-toggle" value="" class="sr-only peer" ${config.darkMode ? 'checked' : ''}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">${config.darkMode ? Icon('Moon', 'w-4 h-4') : Icon('Sun', 'w-4 h-4')}</span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">AI Reminder Template</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
                                Use <strong>[Student Name]</strong> for the AI to personalize the message.
                            </p>
                            <textarea 
                                id="message-template" 
                                class="w-full p-3 h-32 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 bg-gray-50 dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500" 
                                placeholder="Enter your reminder message template..."
                            >${config.messageTemplate}</textarea>
                            <button id="save-config-btn" class="mt-4 w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                                Save Template
                            </button>
                            <p id="config-status" class="text-xs text-center mt-2 hidden"></p>
                        </div>
                        
                    </div>
                </div>
            `;
            
            // --- Event Listeners for Settings View ---
            document.getElementById('dark-mode-toggle').addEventListener('change', async (e) => {
                const darkMode = e.target.checked;
                await updateConfig({ darkMode }); // This updates the config and triggers data reload/re-render
            });

            document.getElementById('save-config-btn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const template = document.getElementById('message-template').value.trim();
                const statusEl = document.getElementById('config-status');
                
                btn.disabled = true;
                btn.innerHTML = `${Icon('Loader', 'w-5 h-5 mr-2 text-white')} Saving...`;
                statusEl.classList.add('hidden');

                try {
                    await updateConfig({ messageTemplate: template });
                    statusEl.textContent = 'Settings saved successfully!';
                    statusEl.classList.remove('hidden', 'text-red-500');
                    statusEl.classList.add('text-green-500');
                } catch (error) {
                    statusEl.textContent = 'Failed to save settings.';
                    statusEl.classList.remove('hidden', 'text-green-500');
                    statusEl.classList.add('text-red-500');
                    console.error(error);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `Save Template`;
                }
            });
        }

        // --- VIEW: Dashboard/Earnings (Simplified) ---
        function renderDashboard() {
            const { students, totalEarnings } = appState;
            const paidStudents = students.filter(s => s.payments?.[currentMonthKey]).length;
            const unpaidStudents = students.length - paidStudents;
            const mainContentEl = document.getElementById('main-content');

            mainContentEl.innerHTML = `
                <div class="p-5 flex flex-col h-full bg-gray-50 dark:bg-gray-900">
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Dashboard</h1>
                    
                    <div class="bg-blue-600 p-6 rounded-xl shadow-2xl text-white mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">Total YTD Earnings</p>
                                <h2 class="text-4xl font-extrabold mt-1">LKR ${totalEarnings.toLocaleString()}</h2>
                            </div>
                            ${Icon('TrendingUp', 'w-10 h-10')}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Paid (${currentMonthName})</p>
                            <h3 class="text-3xl font-bold text-green-600 dark:text-green-400 mt-1">${paidStudents}</h3>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Unpaid (${currentMonthName})</p>
                            <h3 class="text-3xl font-bold text-red-600 dark:text-red-400 mt-1">${unpaidStudents}</h3>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-gray-100">Overview</h3>
                        <p class="text-gray-700 dark:text-gray-300">Total Registered Students: <span class="font-bold text-blue-600">${students.length}</span></p>
                        <p class="text-gray-700 dark:text-gray-300">Monthly Fee: <span class="font-bold text-blue-600">LKR ${FEE_AMOUNT_LKR}</span></p>
                    </div>
                </div>
            `;
        }

        // --- NAVIGATION & ROUTING ---
        function renderBottomNav() {
            const { currentPage } = appState;
            const navEl = document.getElementById('bottom-nav');

            const navItems = [
                { name: 'Dashboard', icon: 'TrendingUp', page: 'Dashboard' },
                { name: 'Students', icon: 'Users', page: 'Students' },
                { name: 'Settings', icon: 'Settings', page: 'Settings' },
            ];

            navEl.innerHTML = `
                <div class="flex justify-around h-14">
                    ${navItems.map(item => `
                        <button
                            data-page="${item.page}"
                            class="nav-button flex flex-col items-center justify-center text-xs font-medium w-full transition duration-150
                            ${currentPage === item.page || (currentPage === 'Add' || currentPage === 'Details') && item.page === 'Students' ? 'active text-blue-600' : 'text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400'}"
                        >
                            ${Icon(item.icon, 'w-5 h-5 mb-1')}
                            ${item.name}
                        </button>
                    `).join('')}
                </div>
            `;

            navEl.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const page = e.currentTarget.dataset.page;
                    setState({ currentPage: page, selectedStudent: null });
                });
            });
        }

        // --- MAIN RENDER FUNCTION ---
        function renderApp() {
            if (!appState.isDataReady) {
                document.getElementById('main-content').innerHTML = `<div class="p-8 text-center text-gray-500 dark:text-gray-400">${Icon('Loader', 'w-8 h-8 mx-auto mb-4 text-blue-600 dark:text-blue-400')} Loading Data...</div>`;
                return;
            }

            // Only show the bottom nav after initial data load
            document.getElementById('bottom-nav').style.display = 'block';

            switch (appState.currentPage) {
                case 'Students':
                    renderStudentsList();
                    break;
                case 'Dashboard':
                    renderDashboard();
                    break;
                case 'Add':
                    renderAddStudent();
                    break;
                case 'Details':
                    renderStudentDetails();
                    break;
                case 'Settings':
                    renderSettings();
                    break;
                default:
                    renderStudentsList();
            }

            // Re-render the bottom navigation on every app state change
            renderBottomNav();
        }

        // --- INITIALIZATION ---
        initDB(); // Start the IndexedDB initialization process
    </script>
</body>
</html>
